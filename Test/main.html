<!DOCTYPE html>
<html>
<head>
</head>
<body>
<canvas id="webgl_canvas" width="1280" height="720"></canvas>
<div id="fps"></div>
<div id="camera_mat"></div>
<div id="proj_mat"></div>

<script src="../Utilities/gl-matrix-min.js"></script>
<script language="javascript" type="text/javascript" src="../Utilities/camera.js"></script>
<script language="javascript" type="text/javascript" src="../Utilities/shaders.js"></script>
<script language="javascript" type="text/javascript" src="../Utilities/textures.js"></script>
<script language="javascript" type="text/javascript" src="../Utilities/objects_02.js"></script>
<script language="javascript" type="text/javascript" src="../Shaders/wall.js"></script>
<script language="javascript" type="text/javascript" src="../Shaders/seat_all.js"></script>
<script>
    async function main() {
        // Boilerplate code
        const canvas = document.getElementById('webgl_canvas');
        c_width = canvas.width
        c_height = canvas.height
        const gl = canvas.getContext('webgl');

        // Enable tests for better rendering
        gl.enable(gl.DEPTH_TEST);
        //gl.enable(gl.CULL_FACE); // cull hidden faces behind normals!

        //Load the object
        var wall = await load_obj('../Objects/Room-SW/mesh/interieur_sw.obj');
        var wall_obj = await make_object(gl, wall)
        var wall_shader_comps = await load_shader_wall(gl);

        var seats = await load_obj("../Objects/Room-SW/mesh/seat/seat_.obj",20);
        var seats_obj = await make_objects(gl,seats);
        var seats_shader_comps = await load_shader_seats(gl);

        //Different shaders here
        var wall_shader = make_shader(gl, (wall_shader_comps).shader_v,(wall_shader_comps).shader_f);
        var seats_shader = make_shader(gl,(seats_shader_comps).shader_v,(seats_shader_comps).shader_f);
        //Define what needed

        //Camera parameters
        position = glMatrix.vec3.fromValues(1, 0, -6.0)
        up = glMatrix.vec3.fromValues(0.0, 1.0, 0.0)
        yaw = -90.0
        pitch = 0.0
        var camera = make_camera(canvas, position, up, yaw, pitch)
        var projection = camera.get_projection(45.0, c_width / c_height, 0.01, 100.0)

        var deltaTime = 0;

        function animate(time) {
            deltaTime += 0.005;
            camera.update(deltaTime);
            //Draw loop
            gl.clearColor(0.5, 0.5, 0.5, 1);
            gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

            view = camera.get_view_matrix();

            //Shaders
            wall_shader.use();
            var unif = wall_shader.get_uniforms();
            gl.uniformMatrix4fv(unif['view'], false, view);
            gl.uniformMatrix4fv(unif['proj'], false, projection);
            wall_obj.activate(wall_shader);
            wall_shader_comps.shader_activate(wall_shader,wall_obj.model,unif['model']);
            wall_obj.draw();

            seats_shader.use()
            var unif = seats_shader.get_uniforms();
            gl.uniformMatrix4fv(unif['view'], false, view);
            gl.uniformMatrix4fv(unif['proj'], false, projection);
            for(var i=0; i<seats_obj.length;i++) {
                seats_obj[i].activate(seats_shader);
                seats_shader_comps.shader_activate(seats_shader, seats_obj[i], unif['model']);
                seats_obj[i].draw();
            }


            fps(time);
            window.requestAnimationFrame(animate); // While(True) loop!
        }

        var prev = 0
        const fpsElem = document.querySelector("#fps");
        function fps(now) {
            now *= 0.001;
            const deltaTime = now - prev;
            prev = now;
            const fps = 1 / deltaTime;
            fpsElem.textContent = 'FPS: ' + fps.toFixed(1);
            return fps;
        }

        animate(0);
    };
    main();
</script>
</body>
</html>


